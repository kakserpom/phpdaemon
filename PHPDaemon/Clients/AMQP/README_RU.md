[TOC]

# Реализация драйвера для AMQP

Протокол AMQP представляет собой RPC вызовы между брокером и клиентом в дуплексном режиме. Пакеты, отправляемые в соединение, называются фреймами.
Для того чтобы начать обмен рукопожатиями (handshake) клиент сначала посылает брокеру хедер \PHPDaemon\Clients\AMQP\AMQPConnection::PROTOCOL_HEADER, содержащий версию протокола.
Если брокер поддерживает такую версию, то в ответ вы получите \PHPDaemon\Clients\AMQP\Driver\Protocol\v091\Protocol\Connection\ConnectionStartFrame.
После получения этого фрейма начинается обмен пакетами для установки устойчивого соединения.

Подробности о протоколе https://www.rabbitmq.com/amqp-0-9-1-reference.html

Драйвер состоит из следующих классов.

1. ```\PHPDaemon\Clients\AMQP\Pool``` - пул соединений.
2. ```\PHPDaemon\Clients\AMQP\Connection``` - класс расширяющий нативный \PHPDaemon\Network\ClientConnection в PhpD
3. ```\PHPDaemon\Clients\AMQP\Channel``` - класс, реализующий канал для взаимодействия с брокером
4. ```\PHPDaemon\Clients\AMQP\Message``` - класс, реализующий сообщение.

## Конфигурация


```
Pool:\PHPDaemon\Clients\AMQP\Pool {
    server 'tcp://127.0.0.1';
    port 5672;
    username 'guest';
    password 'guest';
    vhost '/';
}

```

***

## Работа с драйвером

### Создание соединения.
В общем случае процесс создания соединения выглядит так:
```
#!php
$amqpClient = Pool::getInstance();
$amqpClient->getConnection(function ($connection) {
    /** @var Connection $connection */
    if(!$connection->isConnected()) {
        return;
    }

    // do stuff
});


```
Сначала получаем экземпляр класса *\PHPDaemon\Clients\AMQP\Pool*, затем вызываем метод *getConnection*
Функция обратного вызова будет вызвана непосредственно в момент создания(получения существующего) соединения.
Если это новое соединение, то в момент его создания начинается процесс рукопожатия по протоколу AMQP и открытие канала с id = 1.
При успешном открытии канала будет брошено событие *Connection::ON_HANDSHAKE_EVENT*.
В функцию обратного вызова по событию *Connection::ON_HANDSHAKE_EVENT* будет проброшен экземпляр канала *\PHPDaemon\Clients\AMQP\Channel*

***

### Работа с каналом.

#### Channel::close - закрытие канала

Этот метод осуществляет закрытие канала


#### Channel::declareQueue - объявление очереди
+ ```\PHPDaemon\Clients\AMQP\Channel::declareQueue```
Аргументы:
    - *$name* - имя очереди
    - *$options* - параметры

         - passive - (bool) Если установлено, клиент ответит фрейом ```\PHPDaemon\Clients\AMQP\Driver\Protocol\v091\Protocol\Queue\QueueDeleteOkFrame``` если очередь уже существует. По-умолчанию **FALSE**
         - durable - (bool) Если установлено, то при перезагрузке сервиса очередь будет сохранена. По-умолчанию **FALSE**
         - exclusive - (bool) Если установлено, то очередь будет доступна только для текущего подключения и удалена при разрыве соединения. По-умолчанию **FALSE**
         - autoDelete - (bool)  Если установлено, то очередь будет удалена как только подписчик завершит ее использование. По-умолчанию **FALSE**
         - noWait - (bool) Если установлено в TRUE, то брокер не отправит пакет подтверждения. По-умолчанию **FALSE**
         - arguments - (array) Специфичные для брокера аргументы.

    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов. *Если опция noWait установлена в TRUE, то callback вызван не будет*


#### Channel::deleteQueue - удаление очереди
+ ```\PHPDaemon\Clients\AMQP\Channel::deleteQueue```
Аргументы:
    - *$name* - имя очереди
    - *$options* - параметры

        - ifUnused - (bool) Если установлено в TRUE и есть подписчики на очередь, то удаления не произойдет, а канал закроется. По-умолчанию **FALSE**
        - ifEmpty - (bool) Если установлено в TRUE и в очереди есть сообщения, то удаления не произойдет, а канал закроется. По-умолчанию **FALSE**
        - noWait - (bool) Если установлено в TRUE, то брокер не отправит пакет подтверждения. По-умолчанию **FALSE**

    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов. *Если опция noWait установлена в TRUE, то callback вызван не будет*

#### Channel::purgeQueue - очистка очереди
+ ```\PHPDaemon\Clients\AMQP\Channel::purgeQueue```
Аргументы:
    - *$name* - имя очереди
    - *$options* - параметры

        - noWait - (bool) Если установлено в TRUE, то брокер не отправит пакет подтверждения. По-умолчанию **FALSE**

    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов. *Если опция noWait установлена в TRUE, то callback вызван не будет*

#### Channel::bindQueue - привязка очереди к обменнику
+ ```\PHPDaemon\Clients\AMQP\Channel::bindQueue```
Аргументы:
    - *$name* - имя очереди
    - *$exchangeName* - имя обменника
    - *$routingKey* - ключ для роутинга сообщений
    - *$options* - параметры

            - noWait - (bool) Если установлено в TRUE, то брокер не отправит пакет подтверждения. По-умолчанию **FALSE**

    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов. *Если опция noWait установлена в TRUE, то callback вызван не будет*

#### Channel::unbindQueue - отвязка очереди от обменника
+ ```\PHPDaemon\Clients\AMQP\Channel::unbindQueue```
Аргументы:
    - *$name* - имя очереди
    - *$exchangeName* - имя обменника
    - *$routingKey* - ключ для роутинга сообщений
    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов.

#### Channel::declareExchange - объявление обменника
+ ```\PHPDaemon\Clients\AMQP\Channel::declareExchange```
Аргументы:
    - *$name* - имя обменника
    - *$options* - параметры

         - type - (string) Тип обменника direct|fanout|topic|headers . По-умолчанию **direct**
         - passive - (bool) Если установлено, клиент ответит фрейом ```\PHPDaemon\Clients\AMQP\Driver\Protocol\v091\Protocol\Exchange\ExchangeDeclareOkFrame``` если обменник уже существует. По-умолчанию **FALSE**
         - durable - (bool) Если установлено, то при перезагрузке сервиса обменник будет сохранен. По-умолчанию **FALSE**
         - internal - (bool) Если установлено, то обменник будет доступна только для других обменников. По-умолчанию **FALSE**
         - autoDelete - (bool)  Если установлено, то обменник будет удален как только все очереди, которые его используют, будут отвязаны от этого обменника. По-умолчанию **FALSE**
         - noWait - (bool) Если установлено в TRUE, то брокер не отправит пакет подтверждения. По-умолчанию **FALSE**
         - arguments - (array) Специфичные для брокера аргументы.

    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов. *Если опция noWait установлена в TRUE, то callback вызван не будет*

#### Channel::deleteExchange - удаление обменника
+ ```\PHPDaemon\Clients\AMQP\Channel::deleteExchange```
Аргументы:
    - *$name* - имя обменника
    - *$options* - параметры

            - ifUnused - (bool) Если установлено в TRUE и есть подписчики на обменник, то удаления не произойдет, а канал закроется. По-умолчанию **FALSE**
            - noWait - (bool) Если установлено в TRUE, то брокер не отправит пакет подтверждения. По-умолчанию **FALSE**

    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов.

#### Channel::bindExchange - привязка обменника к другому обменнику
+ ```\PHPDaemon\Clients\AMQP\Channel::deleteExchange```
Аргументы:
    - *$name* - имя обменника источника
    - *$exchangeName* - имя целевого обменника
    - *$routingKey* - ключ для роутинга сообщений
    - *$options* - параметры

            - noWait - (bool) Если установлено в TRUE, то брокер не отправит пакет подтверждения. По-умолчанию **FALSE**

    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов.


#### Channel::unbindExchange - отвязка обменника от другого обменника
+ ```\PHPDaemon\Clients\AMQP\Channel::unbindExchange```
Аргументы:
    - *$name* - имя обменника источника
    - *$exchangeName* - имя целевого обменника
    - *$routingKey* - ключ для роутинга сообщений
    - *$options* - параметры

            - noWait - (bool) Если установлено в TRUE, то брокер не отправит пакет подтверждения. По-умолчанию **FALSE**

    - *$callback* - опционально, функция обратного вызова. Будет вызвана при получении пакета подтверждения. Не передает входных аргументов.


#### Channel::publish - публикация сообщения в обменник
+ ```\PHPDaemon\Clients\AMQP\Channel::unbindExchange```
Аргументы:
    - *$content* - содержимое сообщения
    - *$exchangeName* - имя обменника в который публикуем сообщение
    - *$routingKey* - ключ для роутинга сообщения
    - *$options* - параметры

            - contentLength - (int) длинна содержимого сообщения
            - contentType - (string) mime-type содержимого сообщения, по умолчанию text/plain
            - contentEncoding - (string) кодировка тела сообщения
            - headers - (array) дополнительные заголовки сообщения
            - messageId - (string) идентификатор сообщения
            - deliveryMode - (int) режим доставки
            - correlationId - (string) идентификатор сообщения (RPC)
            - replyTo - (string) имя очереди куда направлять ответ на сообщение (RPC)
            - expiration - (string) дата и время жизни сообщения
            - timestamp - (int) дата и время отправки сообщения
            - type - (string) тип сообщения
            - userId - (string) идентификатор пользователя, отправивший сообщение
            - appId - (string) идентификатор приложения, отправившее сообщение


#### Channel::sendToQueue - прямая отправка сообщения в целевую очередь
+ ```\PHPDaemon\Clients\AMQP\Channel::unbindExchange```
Аргументы:
    - *$content* - содержимое сообщения
    - *$name* - имя очереди в которую публикуем сообщение
    - *$options* - параметры

            - contentLength - (int) длинна содержимого сообщения
            - contentType - (string) mime-type содержимого сообщения, по умолчанию text/plain
            - contentEncoding - (string) кодировка тела сообщения
            - headers - (array) дополнительные заголовки сообщения
            - messageId - (string) идентификатор сообщения
            - deliveryMode - (int) режим доставки
            - correlationId - (string) идентификатор сообщения (RPC)
            - replyTo - (string) имя очереди куда направлять ответ на сообщение (RPC)
            - expiration - (string) дата и время жизни сообщения
            - timestamp - (int) дата и время отправки сообщения
            - type - (string) тип сообщения
            - userId - (string) идентификатор пользователя, отправивший сообщение
            - appId - (string) идентификатор приложения, отправившее сообщение


#### Channel::consume - подписаться на получение сообщений из очереди
+ ```\PHPDaemon\Clients\AMQP\Channel::consume```
Аргументы:
    - *$queueName* - имя очереди, на которую подписываемся
    - *$options* - параметры получения

            - consumerTag - (string) уникальный идентификатор подписчика
            - noLocal - (bool) если установлено в TRUE, то брокер не отправит сообщение в соединение, которое его породило. По-умолчанию **FALSE**
            - noAck - (bool) если установлено в TRUE, то брокер не будет ожидать подтверждения () обработки сообщения. По-умолчанию **FALSE**
            - exclusive - (bool) если установлено в TRUE, то брокер разрешит отправку сообщений только этому подписчику. По-умолчанию **FALSE**
            - noWait - (bool)  если установлено в TRUE, то брокер не отправит сообщение подписчику. По-умолчанию **FALSE**
            - argiments - (array) специальные аргументы, специфичные для брокера.

    - *$callback* - функция обратного вызова. Будет вызвана при получении сообщения. В качестве входящего параметра передается объект *\PHPDaemon\Clients\AMQP\Message*

#### Channel::cancel - отписаться на получение сообщений из очереди
+ ```\PHPDaemon\Clients\AMQP\Channel::cancel```
Аргументы:
    - *$consumerTag* - уникальный идентификатор подписчика
    - *$options* - параметры
            - noWait - (bool)  если установлено в TRUE, то брокер не отправит сообщение подписчику. По-умолчанию **FALSE**


#### Channel::get - получить сообщение из очереди
+ ```\PHPDaemon\Clients\AMQP\Channel::get```
Аргументы:
    - *$queueName* - имя очереди, на которую подписываемся
    - *$options* - параметры получения

            - noAck - (bool) если установлено в TRUE, то брокер не будет ожидать подтверждения () обработки сообщения. По-умолчанию **FALSE**

    - *$callback* - функция обратного вызова. Будет вызвана при получении сообщения. В качестве входящего параметра передается объект *\PHPDaemon\Clients\AMQP\Message* если сообщение было в очереди, иначе **FALSE**


#### Channel::ack - сообщить брокеру о том, что сообщение обработано успешно
+ ```\PHPDaemon\Clients\AMQP\Channel::ack```
Аргументы:
    - *$deliveryTag* - уникальный идентификатор, сгенерированный сервером и валиден только для канала, в котором была попытка доставки сообщения
    - *$options* - параметры

            - multiple - (int) если установлено в 1, то брокер автоматически подтвердит все сообщения. По-умолчанию **0**


#### Channel::nack - сообщить брокеру о том, что сообщение обработано c ошибкой
+ ```\PHPDaemon\Clients\AMQP\Channel::nack```
Аргументы:
    - *$deliveryTag* - уникальный идентификатор, сгенерированный сервером и валиден только для канала, в котором была попытка доставки сообщения
    - *$options* - параметры

            - multiple - (int) если установлено в 1, то брокер автоматически вернет все сообщения. По-умолчанию **0**
            - requeue - (bool) если установлено в TRUE, то брокер вернет сообщение в очередь, иначе сообщение не будет более доставлено. По-умолчанию **TRUE**

#### Channel::reject - отклонить сообщение
+ ```\PHPDaemon\Clients\AMQP\Channel::reject```
Аргументы:
    - *$deliveryTag* - уникальный идентификатор, сгенерированный сервером и валиден только для канала, в котором была попытка доставки сообщения
    - *$options* - параметры

            - requeue - (bool) если установлено в TRUE, то брокер вернет сообщение в очередь. Если переотправка не удается, то сообщение попадет в dead-letters exchange (при наличии). По-умолчанию **TRUE**


#### Channel::recover - повторная отправка сообщения
+ ```\PHPDaemon\Clients\AMQP\Channel::recover```
Аргументы:
    - *$requeue* - (bool) если установлено в TRUE, то брокер переотправит сообщение самому первому получателю. Если переотправка не удается, то сообщение попадет в dead-letters exchange (при наличии). По-умолчанию **FALSE**